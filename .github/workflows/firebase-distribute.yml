name: Build & Distribute to Firebase

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¦ Install npm dependencies
        run: npm install

      - name: ğŸ“¥ Install CocoaPods
        run: |
          cd ios
          pod install
          cd ..

      # - name: ğŸ¤– Build Android APK
      #   run: |
      #     cd android
      #     ./gradlew assembleRelease

      - name: ğŸ Build iOS App (Simulator - Debug)
        run: |
          cd ios
          pod install
          # Archive the app
          xcodebuild \
            -workspace CICDTestApp.xcworkspace \
            -scheme CICDTestApp \
            -sdk iphonesimulator \
            -configuration Debug \
            -derivedDataPath build

          # Export IPA
          # xcodebuild \
          #   -exportArchive \
          #   -archivePath $PWD/build/CICDTestApp.xcarchive \
          #   -exportOptionsPlist ExportOptions.plist \
          #   -exportPath $PWD/build/export

    - name: ğŸ“¦ Package .app into .zip
        run: |
          cd ios/build/Build/Products/Debug-iphonesimulator
          zip -r CICDTestApp.app.zip CICDTestApp.app
          mv CICDTestApp.app.zip $GITHUB_WORKSPACE/

    - name: ğŸ“¤ Upload to Firebase (Optional)
        if: false  # <-- disable unless you have Firebase token
        run: |
          npm install -g firebase-tools
          firebase appdistribution:distribute CICDTestApp.app.zip \
            --app ${{ secrets.IOS_APP_ID }} \
            --token "${{ secrets.FIREBASE_TOKEN }}" \
            --release-notes "Simulator build only - not installable on devices" \
            # --groups testers

    - name: ğŸ“ Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: iOS Simulator App
          path: CICDTestApp.app.zip      

      # - name: ğŸ“¤ Upload iOS IPA to Firebase
      #   run: |
      #     npm install -g firebase-tools

      #     firebase appdistribution:distribute ios/build/export/CICDTestApp.ipa \
      #       --app ${{ secrets.IOS_APP_ID }} \
      #       --token "${{ secrets.FIREBASE_TOKEN }}" \
      #       --release-notes "ğŸš€ Automated build from GitHub Actions" \
      #       --groups testers    

      # - name: ğŸ Build iOS IPA
      #   run: |
      #     cd ios
      #     # xcodebuild \
      #     #   -workspace CICDTestApp.xcworkspace \
      #     #   -scheme CICDTestApp \
      #     #   -sdk iphoneos \
      #     #   -configuration Release \
      #     #   -archivePath $PWD/build/CICDTestApp.xcarchive \
      #     #   archive
      #     #   PRODUCT_BUNDLE_IDENTIFIER=org.reactjs.native.example.CICDTestApp
      #     xcodebuild \
      #       -workspace YourApp.xcworkspace \
      #       -scheme YourApp \
      #       -configuration Debug \
      #       -sdk iphonesimulator \
      #       -derivedDataPath build


      #     xcodebuild \
      #       -exportArchive \
      #       -archivePath $PWD/build/CICDTestApp.xcarchive \
      #       -exportOptionsPlist exportOptions.plist \
      #       -exportPath $PWD/build

      # - name: ğŸ“¤ Upload Android APK to Firebase
      #   run: |
      #     npm install -g firebase-tools
      #     firebase appdistribution:distribute android/app/build/outputs/apk/release/app-release.apk \
      #       --app ${{ secrets.ANDROID_APP_ID }} \
      #       --token "${{ secrets.FIREBASE_TOKEN }}" \
      #       --release-notes "Automated build from GitHub Actions" \
      #       --groups testers

      # - name: ğŸ“¤ Upload iOS IPA to Firebase
      #   run: |
      #     npm install -g firebase-tools
      #     firebase appdistribution:distribute ios/build/CICDTestApp.ipa \
      #       --app ${{ secrets.IOS_APP_ID }} \
      #       --token "${{ secrets.FIREBASE_TOKEN }}" \
      #       --release-notes "Automated build from GitHub Actions" \
      #       --groups testers
