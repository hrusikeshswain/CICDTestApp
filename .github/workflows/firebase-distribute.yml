name: Build & Distribute to Firebase

on:
  push:
    branches: [main]

jobs:
  build:
    name: Build on ${{ github.ref_name }}
    runs-on: macos-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üü¢ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: üì¶ Install npm dependencies
        run: npm install

      - name: üì• Install CocoaPods
        run: |
          cd ios
          pod install
          cd ..

      - name: Make scripts executable
        run: |
          chmod +x .github/scripts/build_ios.sh
          chmod +x .github/scripts/package_app.sh
          chmod +x .github/scripts/upload_firebase.sh

      - name: Run iOS build script
        run: .github/scripts/build_ios.sh

      - name: Package .app into .zip
        run: .github/scripts/package_app.sh

      - name: Upload to Firebase (Optional)
        env:
          IOS_APP_ID: ${{ secrets.IOS_APP_ID }}
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: .github/scripts/upload_firebase.sh

      # - name: üçè Build iOS App (Simulator - Debug)
      #   run: |
      #     cd ios
      #     pod install
      #     # Archive the app
      #     xcodebuild \
      #       -workspace CICDTestApp.xcworkspace \
      #       -scheme CICDTestApp \
      #       -sdk iphonesimulator \
      #       -configuration Debug \
      #       -derivedDataPath build

          # Export IPA
          # xcodebuild \
          #   -exportArchive \
          #   -archivePath $PWD/build/CICDTestApp.xcarchive \
          #   -exportOptionsPlist ExportOptions.plist \
          #   -exportPath $PWD/build/export

      # - name: üì¶ Package .app into .zip
      #   run: |
      #     cd ios/build/Build/Products/Debug-iphonesimulator
      #     zip -r CICDTestApp.app.zip CICDTestApp.app
      #     mv CICDTestApp.app.zip $GITHUB_WORKSPACE/

      # - name: üì§ Upload to Firebase (Optional)
      #   run: |
      #     npm install -g firebase-tools
      #     firebase appdistribution:distribute CICDTestApp.app.zip \
      #       --app ${{ secrets.IOS_APP_ID }} \
      #       --token "${{ secrets.FIREBASE_TOKEN }}" \
      #       --release-notes "Simulator build only - not installable on devices" \
      #       # --groups testers

      - name: üìÅ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS Simulator App
          path: CICDTestApp.app.zip      

      # - name: üì§ Upload iOS IPA to Firebase
      #   run: |
      #     npm install -g firebase-tools

      #     firebase appdistribution:distribute ios/build/export/CICDTestApp.ipa \
      #       --app ${{ secrets.IOS_APP_ID }} \
      #       --token "${{ secrets.FIREBASE_TOKEN }}" \
      #       --release-notes "üöÄ Automated build from GitHub Actions" \
      #       --groups testers    

      # - name: üçè Build iOS IPA
      #   run: |
      #     cd ios
      #     # xcodebuild \
      #     #   -workspace CICDTestApp.xcworkspace \
      #     #   -scheme CICDTestApp \
      #     #   -sdk iphoneos \
      #     #   -configuration Release \
      #     #   -archivePath $PWD/build/CICDTestApp.xcarchive \
      #     #   archive
      #     #   PRODUCT_BUNDLE_IDENTIFIER=org.reactjs.native.example.CICDTestApp
      #     xcodebuild \
      #       -workspace YourApp.xcworkspace \
      #       -scheme YourApp \
      #       -configuration Debug \
      #       -sdk iphonesimulator \
      #       -derivedDataPath build


      #     xcodebuild \
      #       -exportArchive \
      #       -archivePath $PWD/build/CICDTestApp.xcarchive \
      #       -exportOptionsPlist exportOptions.plist \
      #       -exportPath $PWD/build

      # - name: üì§ Upload Android APK to Firebase
      #   run: |
      #     npm install -g firebase-tools
      #     firebase appdistribution:distribute android/app/build/outputs/apk/release/app-release.apk \
      #       --app ${{ secrets.ANDROID_APP_ID }} \
      #       --token "${{ secrets.FIREBASE_TOKEN }}" \
      #       --release-notes "Automated build from GitHub Actions" \
      #       --groups testers

      # - name: üì§ Upload iOS IPA to Firebase
      #   run: |
      #     npm install -g firebase-tools
      #     firebase appdistribution:distribute ios/build/CICDTestApp.ipa \
      #       --app ${{ secrets.IOS_APP_ID }} \
      #       --token "${{ secrets.FIREBASE_TOKEN }}" \
      #       --release-notes "Automated build from GitHub Actions" \
      #       --groups testers
